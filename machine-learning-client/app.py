from flask import request, Flask, render_template, jsonify
from tensorflow.keras.models import load_model
import numpy as np
from random import choice
from PIL import Image
import base64
import os
import glob
import io 
from tensorflow.keras.layers import Dense, MaxPooling2D, Convolution2D, Flatten
from tensorflow import keras 
import tensorflow as tf
import cv2

app = Flask(__name__)
model = load_model('keras10objects.h5')
img = [[[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.03137255],
  [0.19215687],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.07058824],
  [0.39607844],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.25490198],
  [0.03921569],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.06666667],
  [0.38039216],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.21568628],
  [0.37254903],
  [0.00784314],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.03921569],
  [0.3647059 ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.07843138],
  [0.45490196],
  [0.02745098],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.09411765],
  [0.2509804 ],
  [0.32941177],
  [0.5686275 ],
  [0.2784314 ],
  [0.24313726],
  [0.15294118],
  [0.43137255],
  [0.09019608],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.04313726],
  [0.3882353 ],
  [0.4       ],
  [0.23529412],
  [0.21176471],
  [0.37254903],
  [0.1882353 ],
  [0.23529412],
  [0.36078432],
  [0.5411765 ],
  [0.41960785],
  [0.07450981],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.03137255],
  [0.13333334],
  [0.        ],
  [0.43529412],
  [0.2       ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.25882354],
  [0.5686275 ],
  [0.04313726],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.02352941],
  [0.35686275],
  [0.43529412],
  [0.30588236],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.36078432],
  [0.17254902],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.4627451 ],
  [0.03921569],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.11372549],
  [0.4392157 ],
  [0.09803922],
  [0.10196079],
  [0.07450981],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.13725491],
  [0.35686275],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.03137255],
  [0.6       ],
  [0.3647059 ],
  [0.35686275],
  [0.2627451 ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.30980393],
  [0.1882353 ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.3882353 ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.38431373],
  [0.07058824],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.01176471],
  [0.4117647 ],
  [0.00784314],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.39215687],
  [0.03137255],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.07450981],
  [0.38039216],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.03921569],
  [0.11372549],
  [0.11372549],
  [0.45882353],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.25490198],
  [0.3372549 ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.11764706],
  [0.34509805],
  [0.34509805],
  [0.4627451 ],
  [0.22352941],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.02745098],
  [0.47843137],
  [0.4862745 ],
  [0.05882353],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.01568628],
  [0.42745098],
  [0.3019608 ],
  [0.03921569],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.05882353],
  [0.4392157 ],
  [0.18431373],
  [0.13333334],
  [0.38039216],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.00392157],
  [0.25882354],
  [0.42745098],
  [0.4117647 ],
  [0.3137255 ],
  [0.25882354],
  [0.22352941],
  [0.21568628],
  [0.24705882],
  [0.37254903],
  [0.4392157 ],
  [0.1764706 ],
  [0.        ],
  [0.        ],
  [0.39215687],
  [0.13333334],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.14509805],
  [0.4117647 ],
  [0.16078432],
  [0.21176471],
  [0.24313726],
  [0.33333334],
  [0.39215687],
  [0.11764706],
  [0.00392157],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.12156863],
  [0.38039216],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.05098039],
  [0.45490196],
  [0.07450981],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.13725491],
  [0.29803923],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.35686275],
  [0.04705882],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.27450982],
  [0.20392157],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.15686275],
  [0.30980393],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.01176471],
  [0.00784314],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.01960784],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.16078432],
  [0.3137255 ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.14117648],
  [0.28235295],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.01176471],
  [0.02352941],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]],

 [[0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ],
  [0.        ]]]
for i in range(0, len(img)):
    for j in range(0, len(img[i])):
        for k in range(len(img[i][j])):
            if(img[i][j][k] > 0):
                img[i][j][k] += 1

f = open("categories.txt","r")
classes = f.read().split('\n')[:-1]
f.close()
#def predict():
 #   pred = model.predict(np.expand_dims(img, axis=0))[0]
  #  print(max(pred))
   # ind = (-pred).argsort()[:5]
   # latex = [classes[x] for x in ind]
   # print(latex)

#predict()

@app.route('/')
def index():
	return render_template('index.html')

@app.route('/puzzle')
def puzzle():
    return getObject()

@app.route('/check', methods=['POST'])
def check():
    data = request.get_json()
    return jsonify({ 'result': predict(data['image'], data['category']) })

def getObject():
    return choice(classes)
	
def predict(image, category):
	image = base64.b64decode(image)
	image = Image.open(io.BytesIO(image)).convert('L').resize((28, 28))
	image = np.array(image).reshape(28,28,1).astype('float32')/255.0
	print(image)
	for i in range(0, len(image)):
		for j in range(0, len(image[i])):
			for k in range(0, len(image[i][j])):
				if(image[i][j][k] > 0):
					image[i][j][k] += 2
	prediction = model.predict(np.expand_dims(image, axis=0))[0]
	print(max(prediction))
	ind = (-prediction).argsort()[:5]
	result = [ classes[x] for x in ind]
	print(result)
	try:
		return result.index(category)+1
	except ValueError:
		return 0

if __name__ == '__main__':
	app.run(debug=True)